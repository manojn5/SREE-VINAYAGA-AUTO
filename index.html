<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Object ID Pro â€” MobileNet AI (Fixed)</title>

<style>
body{margin:0;padding:24px;background:#0f1724;color:#e6eef6;font-family:system-ui}
.container{display:grid;grid-template-columns:420px 1fr;gap:20px}
.card{background:#0b1220;padding:16px;border-radius:12px}
input,button{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:none}
button{background:#06b6d4;font-weight:700;cursor:pointer}
button.ghost{background:transparent;color:#94a3b8;border:1px solid #1e293b}
.list{margin-top:10px;display:grid;gap:8px}
.item{display:flex;gap:8px;background:#111827;padding:6px;border-radius:8px;align-items:center}
.item img{width:60px;height:45px;object-fit:cover;border-radius:6px}
.del{margin-left:auto;background:#7f1d1d;color:#fff;padding:4px 8px;border-radius:6px;cursor:pointer}
video{width:100%;border-radius:10px;margin-top:8px}
.result{margin-top:10px;padding:10px;border-radius:10px;background:#022c22}
.cam-row{display:flex;gap:6px}
@media(max-width:900px){.container{grid-template-columns:1fr}}
</style>

<!-- TensorFlow -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
</head>

<body>

<h2>Object ID Pro â€” MobileNet AI</h2>

<div class="container">

<div class="card">
<h3>Register Object</h3>
<input type="file" id="addFile" accept="image/*">
<div class="cam-row">
  <button class="ghost" id="camAddBtn">ğŸ“· Camera</button>
  <button class="ghost" id="switchCamBtn">ğŸ”„ Switch</button>
</div>
<input id="serial" placeholder="Serial">
<input id="place" placeholder="Place">
<button id="addBtn">Register</button>
<div class="list" id="list"></div>
</div>

<div class="card">
<h3>Scan Object</h3>
<input type="file" id="scanFile" accept="image/*">
<button id="scanBtn">ğŸ” Scan Image</button>
<div class="cam-row">
  <button class="ghost" id="camScanBtn">ğŸ“¸ Camera Scan</button>
  <button class="ghost" id="switchCamBtn2">ğŸ”„ Switch</button>
</div>
<video id="video" autoplay playsinline style="display:none"></video>
<button id="snapBtn" style="display:none">ğŸ“¸ Capture</button>
<div class="result" id="result" style="display:none"></div>
</div>

</div>

<script>
/* ================= MODEL ================= */
let model;
async function loadModel(){
  await tf.setBackend('webgl');
  await tf.ready();
  model = await mobilenet.load({version:2, alpha:1.0});
  console.log("âœ… MobileNet loaded");
}
loadModel();

/* ================= STORAGE ================= */
const META_KEY="object-meta-ai";
const DB_NAME="ObjectIDFiles";
const STORE="images";
let stream, facingMode="environment";

if(navigator.storage?.persist) navigator.storage.persist();

function openDB(){
  return new Promise(res=>{
    const r=indexedDB.open(DB_NAME,1);
    r.onupgradeneeded=e=>e.target.result.createObjectStore(STORE,{keyPath:"id"});
    r.onsuccess=()=>res(r.result);
  });
}

async function saveImage(blob){
  const db=await openDB();
  const id=Date.now()+Math.random();
  db.transaction(STORE,"readwrite").objectStore(STORE).put({id,blob});
  return id;
}
async function deleteImage(id){
  const db=await openDB();
  db.transaction(STORE,"readwrite").objectStore(STORE).delete(id);
}
async function loadImage(id){
  const db=await openDB();
  return new Promise(r=>{
    db.transaction(STORE).objectStore(STORE).get(id).onsuccess=e=>{
      r(URL.createObjectURL(e.target.result.blob));
    };
  });
}

const loadMeta=()=>JSON.parse(localStorage.getItem(META_KEY)||"[]");
const saveMeta=d=>localStorage.setItem(META_KEY,JSON.stringify(d));

/* ================= AI HELPERS ================= */
async function getEmbeddingFromCanvas(canvas){
  const c=document.createElement("canvas");
  c.width=c.height=224;
  c.getContext("2d").drawImage(canvas,0,0,224,224);

  const t=tf.browser.fromPixels(c)
    .toFloat()
    .div(255)
    .expandDims(0);

  const e=model.infer(t,true);
  const v=await e.data();

  tf.dispose([t,e]);
  return Array.from(v);
}

function cosine(a,b){
  let dot=0,na=0,nb=0;
  for(let i=0;i<a.length;i++){
    dot+=a[i]*b[i];
    na+=a[i]*a[i];
    nb+=b[i]*b[i];
  }
  return dot/(Math.sqrt(na)*Math.sqrt(nb));
}

/* ================= UI ================= */
const list=document.getElementById("list");
const video=document.getElementById("video");
const snapBtn=document.getElementById("snapBtn");
const result=document.getElementById("result");

async function render(){
  list.innerHTML="";
  for(const o of loadMeta()){
    const src=await loadImage(o.imgId);
    list.innerHTML+=`
      <div class="item">
        <img src="${src}">
        <div><b>${o.serial}</b><br><small>${o.place}</small></div>
        <div class="del" onclick="removeItem(${o.id},${o.imgId})">ğŸ—‘ï¸</div>
      </div>`;
  }
}
async function removeItem(id,imgId){
  if(!confirm("Delete object?")) return;
  await deleteImage(imgId);
  saveMeta(loadMeta().filter(o=>o.id!==id));
  render();
}
render();

/* ================= CAMERA ================= */
async function startCamera(){
  video.style.display=snapBtn.style.display="block";
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode}});
  video.srcObject=stream;
}
function stopCamera(){
  stream?.getTracks().forEach(t=>t.stop());
  video.style.display=snapBtn.style.display="none";
}
switchCamBtn.onclick=switchCamBtn2.onclick=()=>{
  facingMode=facingMode==="user"?"environment":"user";
  if(stream){stopCamera();startCamera();}
};

/* ================= REGISTER ================= */
addBtn.onclick=async()=>{
  if(!addFile.files[0] || !model) return;

  const img=new Image();
  img.src=URL.createObjectURL(addFile.files[0]);
  await img.decode();

  const c=document.createElement("canvas");
  c.width=img.width; c.height=img.height;
  c.getContext("2d").drawImage(img,0,0);

  const embedding=await getEmbeddingFromCanvas(c);
  const imgId=await saveImage(addFile.files[0]);

  const db=loadMeta();
  db.push({id:Date.now(),imgId,serial:serial.value,place:place.value,embedding});
  saveMeta(db);
  render();
  alert("âœ… Registered (Upload)");
};

camAddBtn.onclick=async()=>{
  if(!model) return alert("Model loading...");
  await startCamera();
  snapBtn.onclick=async()=>{
    const c=document.createElement("canvas");
    c.width=video.videoWidth;
    c.height=video.videoHeight;
    c.getContext("2d").drawImage(video,0,0);
    stopCamera();

    const blob=await new Promise(r=>c.toBlob(r,"image/jpeg",0.95));
    const imgId=await saveImage(blob);
    const embedding=await getEmbeddingFromCanvas(c);

    const db=loadMeta();
    db.push({id:Date.now(),imgId,serial:serial.value,place:place.value,embedding});
    saveMeta(db);
    render();
    alert("âœ… Registered (Camera)");
  };
};

/* ================= SCAN ================= */
scanBtn.onclick=()=>scan(scanFile.files[0]);

camScanBtn.onclick=async()=>{
  if(!model) return alert("Model loading...");
  await startCamera();
  snapBtn.onclick=async()=>{
    const c=document.createElement("canvas");
    c.width=video.videoWidth;
    c.height=video.videoHeight;
    c.getContext("2d").drawImage(video,0,0);
    stopCamera();
    scan(await new Promise(r=>c.toBlob(r)));
  };
};

async function scan(file){
  if(!file) return;
  const img=new Image();
  img.src=URL.createObjectURL(file);
  await img.decode();

  const c=document.createElement("canvas");
  c.width=img.width; c.height=img.height;
  c.getContext("2d").drawImage(img,0,0);

  const q=await getEmbeddingFromCanvas(c);

  let best={s:-1,o:null};
  for(const o of loadMeta()){
    const s=cosine(q,o.embedding);
    if(s>best.s) best={s,o};
  }

  result.style.display="block";
  result.innerHTML=best.o && best.s>0.75
    ? `âœ… MATCH<br>Serial: ${best.o.serial}<br>Place: ${best.o.place}<br>Confidence: ${(best.s*100).toFixed(1)}%`
    : "âŒ No match found";
}
</script>
</body>
</html>
